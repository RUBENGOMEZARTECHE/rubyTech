---
export interface Props {
  title?: string;
  metaTitle?: string;
  metaDescription?: string;
  keywords?: string;
}
const { //CONECTAMOS EL FRONTEND CON EL SEO
  title = 'RubyTech',
  metaTitle,
  metaDescription = 'RubyTech - Tu tienda de tecnolog√≠a premium. M√≥viles, port√°tiles y ordenadores de sobremesa con las mejores ofertas del mercado.',
  keywords = 'tecnolog√≠a, m√≥viles, port√°tiles, ordenadores, RubyTech'
} = Astro.props;
---

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{metaTitle || title + ' ‚Äî RubyTech'}</title>
  <meta name="description" content={metaDescription} />
  <meta name="keywords" content={keywords} />
  <meta property="og:title" content={metaTitle || title + ' ‚Äî RubyTech'} />
  <meta property="og:description" content={metaDescription} />
  <meta name="robots" content="index, follow" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="/src/styles/global.css" />
</head>
<body>

<!-- NAVIGATION -->
<nav class="nav" id="navbar">
  <div style="display:flex;align-items:center;gap:.4rem">
    <a href="/" class="nav-logo">
      <span class="fa-solid fa-gem"></span>
      <span>RubyTech</span>
    </a>
    <button id="oscuro-claro" style="background:none;border:none;cursor:pointer;font-size:1.3rem">üåô</button>
  </div>
  <div class="nav-links" id="navLinks">
    <a href="/" class="nav-link"><span class="fa-solid fa-house"></span> Inicio</a>
    <a href="/catalogo" class="nav-link"><span class="fa-solid fa-grid-2"></span> Cat√°logo</a>
    <a href="/blog" class="nav-link"><span class="fa-solid fa-newspaper"></span> Blog</a>
    <a href="/laboratorio" class="nav-link"><span class="fa-solid fa-flask"></span> Laboratorio</a>
    <a href="/contacto" class="nav-link"><span class="fa-solid fa-envelope"></span> Contacto</a>
  </div>
  <div style="display:flex;align-items:center;gap:.6rem">
    <button class="nav-cart" id="btnCarrito">
      <span class="fa-solid fa-cart-shopping"></span>
      <span class="badge">0</span>
    </button>
    <button class="menu-toggle" id="menuToggle">
      <span class="fa-solid fa-bars"></span>
    </button>
  </div>
</nav>

<!-- Aqui estara todo el contenido de la pagina -->
<slot />

<!-- FOOTER -->
<footer class="footer">
  <div class="footer-grid">
    <div class="footer-brand">
      <h3><span class="fa-solid fa-gem"></span> <span>RubyTech</span></h3>
      <p>Tu tienda de confianza en electr√≥nica premium. Los mejores productos al mejor precio con garant√≠a y env√≠o r√°pido.</p>
      <div class="footer-socials">
        <a href="#"><span class="fa-brands fa-facebook-f"></span></a>
        <a href="#"><span class="fa-brands fa-twitter"></span></a>
        <a href="#"><span class="fa-brands fa-instagram"></span></a>
        <a href="#"><span class="fa-brands fa-youtube"></span></a>
        <a href="#"><span class="fa-brands fa-tiktok"></span></a>
      </div>
    </div>
    <div class="footer-col">
      <h4>Categor√≠as</h4>
      <a href="/catalogo?cat=moviles">M√≥viles</a>
      <a href="/catalogo?cat=portatiles">Port√°tiles</a>
      <a href="/catalogo?cat=ordenadores-de-sobremesa">Sobremesa</a>
    </div>
    <div class="footer-col">
      <h4>Empresa</h4>
      <a href="#">Sobre nosotros</a>
      <a href="/blog">Blog</a>
      <a href="/contacto">Contacto</a>
    </div>
    <div class="footer-col">
      <h4>Ayuda</h4>
      <a href="#">Env√≠os y entregas</a>
      <a href="#">Devoluciones</a>
      <a href="#">Garant√≠a</a>
      <a href="#">Preguntas frecuentes</a>
    </div>
  </div>
  <div class="footer-bottom">
    <p>&copy; 2024 RubyTech. Todos los derechos reservados. Dise√±ado con <span class="fa-solid fa-heart" style="color:var(--red)"></span></p>
  </div>
</footer>

<script>
  // position fixed del header
  window.addEventListener('scroll', () => {
    const nav = document.getElementById('navbar');
    nav?.classList.toggle('scrolled', window.scrollY > 50);
  });

  // Mobile menu toggle // "?"" si el elemento existe, continuar√° y si no existe no har√° nada
  document.getElementById('menuToggle')?.addEventListener('click', () => {
    document.getElementById('navLinks')?.classList.toggle('open');
  });

  // Marcar enlace activo
  const links = document.querySelectorAll('.nav-link');
  links.forEach(link => {
    if (link.getAttribute('href') === window.location.pathname) { //compara cada hrf de cada enlace con la pagina en la que me encuentro "window.location.pathname", si me encuentro en /catalogo, compara cada <a> con mi pagina actual
      link.classList.add('active');
    }
  });
</script>

<!-- CARRITO LATERAL -->
<div id="carritoOverlay" class="hidden fixed inset-0 bg-black/60 z-[1999] backdrop-blur-sm"></div>

<div id="carritoPanel" class="fixed top-0 right-[-420px] w-[420px] h-screen z-[2000] flex flex-col transition-all duration-300" style="background:var(--bg2);border-left:1px solid rgba(255,255,255,.08)">

  <!-- HEADER -->
  <div class="flex justify-between items-center" style="border-bottom:1px solid rgba(255,255,255,.08);padding:1.5rem 2rem">
    <h3 class="text-xl font-black">üõí Tu carrito</h3>
    <button id="cerrarCarrito" class="w-9 h-9 rounded-xl cursor-pointer text-lg" style="background:var(--bg3);border:none;color:var(--text)">‚úï</button>
  </div>

  <!-- ITEMS -->
  <div id="carritoItems" class="flex-1 overflow-y-auto" style="padding:1.5rem 2rem"></div>

  <!-- VAC√çO -->
  <div id="carritoVacio" class="hidden flex-1 flex-col items-center justify-center gap-4 text-center p-8">
    <span class="fa-solid fa-cart-shopping text-5xl" style="color:var(--text3)"></span>
    <p style="color:var(--text3)">Tu carrito est√° vac√≠o</p>
    <a href="/catalogo" class="btn btn-primary" onclick="cerrarCarrito()"><span class="fa-solid fa-bag-shopping"></span> Ver Cat√°logo</a>
  </div>

  <!-- FOOTER -->
  <div id="carritoFooter" class="hidden" style="border-top:1px solid rgba(255,255,255,.08);padding:1.5rem 2rem">
    <div class="flex justify-between mb-2 text-sm" style="color:var(--text2)">
      <span>Subtotal</span><span id="carritoSubtotal">0‚Ç¨</span>
    </div>
    <div class="flex justify-between mb-4 text-sm" style="color:var(--text2)">
      <span>Env√≠o</span><span style="color:var(--green)">Gratis</span>
    </div>
    <div class="flex justify-between font-black text-xl mb-6" style="border-top:1px solid rgba(255,255,255,.08);padding-top:1rem">
      <span>Total</span>
      <span id="carritoTotal" style="background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent">0‚Ç¨</span>
    </div>
    <button class="btn btn-primary w-full justify-center">
      <span class="fa-solid fa-credit-card"></span> Finalizar compra
    </button>
  </div>

</div>

<script is:inline> //USAREMOS IS:INLINE PARA QUE ASTRO NO LE HAGA CASO A ESTE SCRIPT, POR LO CONTRARIO PODR√Å OPTIMIZARLO O INCLUSO MODIFICARLO

  function getCarrito() {
    return JSON.parse(localStorage.getItem('carrito') || '[]'); 
    //guardar√° los datos aun recargando la pagina
    //JSON.parse convierte ese texto en un array de JavaScript real con el que podemos trabajar
    //busca un dato guardado con el nombre carrito si no encuentra nada, devuelve null y usara un array vacio
  }

  function saveCarrito(carrito) {
    localStorage.setItem('carrito', JSON.stringify(carrito)); //guarda un dato con ese nombre y convierte el array del carrito en texto
    actualizarBadge(); //Actualiza la cantidad del carrito
  }

  function actualizarBadge() {
    var carrito = getCarrito(); //obtiene el array del carrito guardado en local
    var total = carrito.reduce(function(acumulador, p){ //con el metodo reduce calculamos el total
      return acumulador + p.cantidad; 
    }, 0);
    var badge = document.querySelector('.nav-cart .badge');
    if (badge) badge.textContent = total.toString(); //convierte el numero en string para poder mostrarlo
  }

  function getIcono(catSlug) { //Esta funcion la usaremos para mostrar el icono del producto que estamos comprando 
    if (catSlug === 'moviles') return 'fa-mobile-screen-button';
    if (catSlug === 'portatiles') return 'fa-laptop';
    return 'fa-desktop';
  }

  function renderCarrito() {
    var carrito = getCarrito(); //obtiene el array del carrito guardado en local
    var itemsCarrito = document.getElementById('carritoItems');
    var carritoVacio = document.getElementById('carritoVacio');
    var footerCarrito = document.getElementById('carritoFooter');

    if (!itemsCarrito) return; //si itemsCrrito no existe en html no hara nada

    if (carrito.length === 0) { //si el carrito esta vacio, el contenedor del carrito = vacio, mensaje de vacio = visible, total = oculto
      itemsCarrito.style.display = 'none';
      carritoVacio.style.display = 'flex';
      footerCarrito.style.display = 'none';
      return;
    }

    //Lo contario a lo de arriba
    carritoVacio.style.display = 'none';
    itemsCarrito.style.display = 'block';
    footerCarrito.style.display = 'block';

    var html = '';
    for (var i = 0; i < carrito.length; i++) {  //Recorremos cada producto del carrito y construimos el HTML de cada producto usando innerHTML
      var item = carrito[i]; //guardamos el producto en una variable
      html += '<div class="rounded-xl mb-3 grid gap-3 items-center" style="background:var(--bg3);grid-template-columns:50px 1fr;padding:1rem 1.2rem">';
      html += '<div class="w-12 h-12 rounded-lg flex items-center justify-center text-xl" style="background:var(--bg4);color:rgba(255,255,255,.2)">';
      html += '<i class="fa-solid ' + getIcono(item.catSlug) + '"></i></div>';
      html += '<div>';
      html += '<div class="text-xs font-bold uppercase tracking-widest" style="color:var(--accent)">' + item.brand + '</div>';
      html += '<div class="font-bold text-sm my-1">' + item.name + '</div>';
      html += '<div class="flex items-center justify-between mt-2">';
      html += '<div class="flex items-center gap-2">';
      html += '<button onclick="cambiarCantidad(\'' + item.id + '\', -1)" class="w-7 h-7 rounded-lg cursor-pointer text-base" style="background:var(--bg2);color:var(--text);border:1px solid rgba(255,255,255,.1)">‚àí</button>';
      html += '<span class="font-bold text-sm">' + item.cantidad + '</span>';
      html += '<button onclick="cambiarCantidad(\'' + item.id + '\', 1)" class="w-7 h-7 rounded-lg cursor-pointer text-base" style="background:var(--bg2);color:var(--text);border:1px solid rgba(255,255,255,.1)">+</button>';
      html += '</div>';
      html += '<div class="flex items-center gap-3">';
      html += '<span class="font-black text-sm" style="background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent">' + (item.price * item.cantidad).toLocaleString('es-ES') + '‚Ç¨</span>';
      html += '<button onclick="eliminarItem(\'' + item.id + '\')" class="cursor-pointer text-sm" style="background:none;border:none;color:var(--red)"><i class="fa-solid fa-trash"></i></button>';
      html += '</div></div></div></div>';
    }
    itemsCarrito.innerHTML = html;

    var total = carrito.reduce(function(acum, p){ //calcular el total usando reduce
      return acum + p.price * p.cantidad; 
    }, 0);

    document.getElementById('carritoSubtotal').textContent = total + ' ‚Ç¨'; //muestra el precio antes de hacer la accion de comprar
    document.getElementById('carritoTotal').textContent = total + ' ‚Ç¨'; //muestra el precio una vez el usuario va a pagar de verdad
  }

  function abrirCarrito() { //Abre el carrito
    document.getElementById('carritoPanel').style.right = '0'; //desliza el carrito hasta una posicion visible
    document.getElementById('carritoOverlay').classList.remove('hidden');
    document.getElementById('carritoOverlay').classList.add('block');
    renderCarrito();
  }

  function cerrarCarrito() { //cierra el carrito
    document.getElementById('carritoPanel').style.right = '-420px'; //lo pone invisible
    document.getElementById('carritoOverlay').classList.add('hidden');
    document.getElementById('carritoOverlay').classList.remove('block');
  }


  //EN ESTA FUNCION Y EN LA DE ABAJO USARE WINDOW.() YA QUE AL LLAMARSE LAS FUNCIONES DESDE EL HTML Y USAR EL ONCLICK Y USO FUNCTION ASTRO PUEDE QUE NO ENCUENTRE LA FUNCION
  window.cambiarCantidad = function(id, cambio) { //Esta funcion nos permite a√±adir 1 o restar 1 cantidad del mismo productoya dentro del carrito
    var carrito = getCarrito(); //obtengo el carrito
    for (var i = 0; i < carrito.length; i++) { //lo recorrremos
      if (carrito[i].id === id) { //si encuentra el producto, le suma o le resta cantidad
        carrito[i].cantidad += cambio;
        if (carrito[i].cantidad <= 0) carrito.splice(i, 1); //si la cantidad de ese producto llega a 0, elimina el producto del carrito
        break;
      }
    }
    saveCarrito(carrito); //guarda el carrito en local
    renderCarrito();
  }

  window.eliminarItem = function(id) { //poder eliminar el item que queramos del carrito
    var carrito = getCarrito(); //volvemos a obtener el carrito
    var carritoActualizado = carrito.filter(function(item) { //filtramos para capturar el id del producto que queremos eliminar
        return item.id !== id;
    });

    saveCarrito(carritoActualizado); //guardamos
    renderCarrito();
  }

  document.addEventListener('DOMContentLoaded', function() {
    actualizarBadge();
    document.getElementById('btnCarrito').addEventListener('click', abrirCarrito);
    document.getElementById('cerrarCarrito').addEventListener('click', cerrarCarrito);
    document.getElementById('carritoOverlay').addEventListener('click', cerrarCarrito);
  });
</script>

<script is:inline>
  var btn = document.getElementById('oscuro-claro');

  function oscuroClaro(dark) {
    if (dark) {
      document.documentElement.style.filter = ''; //filter hace que afecte a todo el proyecto, no solo a un apartado o item
      btn.textContent = 'üåô';
    } else {
      document.documentElement.style.filter = 'invert(1) hue-rotate(180deg)'; //invierto todos los colores 180 grados en el circulo cromatico
      btn.textContent = '‚òÄÔ∏è';
    }
    localStorage.setItem('dark', dark);
  }

  var dark = localStorage.getItem('dark') === 'false' ? false : true; // Si el usuario guard√≥ 'false' en el navegador, dark ser√° false, si no, ser√° true (modo oscuro por defecto)
  oscuroClaro(dark);

  btn.onclick = function() { // Cuando el usuario hace clic en el bot√≥n, cambia el modo oscuro/claro al contrario del que est√°
    dark = !dark;
    oscuroClaro(dark);
  }
</script>

</body>
</html>