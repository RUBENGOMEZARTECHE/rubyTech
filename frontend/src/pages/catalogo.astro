---
import MainLayout from '../layouts/MainLayout.astro';
import { getProducts, getCategories } from '../lib/api.js';

const products = await getProducts();
const categories = await getCategories();
---

<MainLayout title="Catálogo">
  <section class="section" style="padding-top:100px">
    <div class="section-header">
      <h2>Nuestro <span class="gradient">Catálogo</span></h2>
      <p>Explora todos nuestros productos de tecnología premium</p>
    </div>

    <div class="catalog-controls">
      <div class="filter-btns">
        <button class="filter-btn active" data-cat="all">Todos</button>
        {categories.map((cat: any) => (
          <button class="filter-btn" data-cat={cat.slug}>
            <i class={`fa-solid ${cat.slug === 'moviles' ? 'fa-mobile-screen' : cat.slug === 'portatiles' ? 'fa-laptop' : 'fa-desktop'}`}></i>
            {cat.name}
          </button>
        ))}
      </div>

      <div class="relative" style="margin-left:auto">
        <button id="btnFiltros" class="flex items-center gap-2 rounded-full text-sm font-medium cursor-pointer transition-all" style="background:var(--bg3);color:var(--text2);border:1px solid transparent;padding:.55rem 1.3rem">
          <i class="fa-solid fa-sliders"></i> Filtrar
        </button>
        <div id="panelFiltros" class="hidden rounded-2xl" style="position:absolute;top:calc(100% + .5rem);right:0;width:280px;z-index:100;background:var(--bg2);border:1px solid rgba(255,255,255,.08);padding:2rem">
    
          <h4 class="text-sm font-bold" style="color:var(--text);margin-bottom:1rem">Ordenar por precio</h4>
          <div class="flex flex-col" style="gap:.6rem;margin-bottom:1.5rem">
            <button class="orden-btn text-left px-3 py-2 rounded-xl text-sm cursor-pointer" data-orden="asc" style="background:var(--bg3);color:var(--text2);border:1px solid transparent">
              <i class="fa-solid fa-arrow-up"></i> Precio: menor a mayor
            </button>
            <button class="orden-btn text-left px-3 py-2 rounded-xl text-sm cursor-pointer" data-orden="desc" style="background:var(--bg3);color:var(--text2);border:1px solid transparent">
              <i class="fa-solid fa-arrow-down"></i> Precio: mayor a menor
            </button>
            <button class="orden-btn text-left px-3 py-2 rounded-xl text-sm cursor-pointer" data-orden="none" style="background:var(--bg3);color:var(--text2);border:1px solid transparent">
              <i class="fa-solid fa-rotate-left"></i> Sin ordenar
            </button>
        </div>

        <h4 class="text-sm font-bold" style="color:var(--text);margin-bottom:1rem">Filtrar por marca</h4>
        <div id="marcasFiltro" class="flex flex-wrap gap-2"></div>

        </div>
      </div>

      <div class="search-box">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="searchInput" placeholder="Buscar producto..." />
      </div>
    </div>

    <div class="products-grid" id="catalogProducts">
      {products.map((p: any) => (
        <a href={`/productos/${p.slug}`} class="product-card" data-cat={p.category?.slug}>
          <div class="product-img" style="background:var(--bg3)">
            {p.badge && (
              <span class={`product-badge ${p.badge}`}>
                {p.badge === 'new' ? 'Nuevo' : p.badge === 'sale' ? 'Oferta' : 'Popular'}
              </span>
            )}
            {p.image?.url
              ? <img src={`http://46.62.132.241:1337${p.image.url}`} alt={p.name} style="width:100%;height:100%;object-fit:contain;padding:1rem" />
              : <i class={`fa-solid ${p.category?.slug === 'moviles' ? 'fa-mobile-screen-button' : p.category?.slug === 'portatiles' ? 'fa-laptop' : 'fa-desktop'}`}></i>
            }
            <span class="quick-view"><i class="fa-solid fa-eye"></i> Ver detalles</span>
          </div>
          <div class="product-info">
            <div class="product-brand">{p.brand}</div>
            <h3 class="product-name">{p.name}</h3>
            <div class="product-price">
              <span class="price-current">{p.price.toLocaleString('es-ES')}€</span>
              {p.previousPrice && <span class="price-old">{p.previousPrice.toLocaleString('es-ES')}€</span>}
            </div>
            <button class="btn-comprar"
              data-id={p.documentId}
              data-name={p.name}
              data-brand={p.brand}
              data-price={p.price}
              data-cat={p.category?.slug}
              style="margin-top:.8rem;width:100%;padding:.6rem;border-radius:10px;font-weight:700;font-size:.85rem;cursor:pointer;background:rgba(108,92,231,.3);border:1px solid rgba(108,92,231,.5);color:white;border:none;transition:var(--transition)">
              COMPRAR
            </button>
          </div>
        </a>
      ))}
    </div>
    <div class="products-count" id="productsCount"></div>
    <div id="paginacion" style="display:none;justify-content:center;gap:.5rem;margin-top:2rem"></div>
  </section>

  <script is:inline>
  document.querySelectorAll('.btn-comprar').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      var carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
      var id = btn.getAttribute('data-id');
      var existing = carrito.find(function(i) { return i.id === id; });
      if (existing) {
        existing.cantidad += 1;
      } else {
        carrito.push({
          id: id,
          name: btn.getAttribute('data-name'),
          brand: btn.getAttribute('data-brand'),
          price: parseFloat(btn.getAttribute('data-price')),
          catSlug: btn.getAttribute('data-cat'),
          cantidad: 1
        });
      }
      localStorage.setItem('carrito', JSON.stringify(carrito));
      var total = carrito.reduce(function(t, i) { return t + i.cantidad; }, 0);
      var badge = document.querySelector('.nav-cart .badge');
      if (badge) badge.textContent = total.toString();
      btn.innerhtml += '<div class="rounded-xl mb-3 grid gap-3 items-center" style="background:var(--bg3);grid-template-columns:50px 1fr;padding:1rem 1.2rem">';
      html += '<div class="w-12 h-12 rounded-lg flex items-center justify-center text-xl" style="background:var(--bg4);color:rgba(255,255,255,.2)">';
      html += '<i class="fa-solid ' + getIcono(item.catSlug) + '"></i></div>';TML = '<i class="fa-solid fa-check"></i> ¡Añadido!';
      btn.style.background = 'linear-gradient(135deg,#6ee7b7,#34d399)';
      setTimeout(function() {
        btn.innerHTML = 'COMPRAR';
        btn.style.background = 'rgba(108,92,231,.3)';
      }, 1500);
    });
  });
</script>
</MainLayout>

<script>
  const cards = document.querySelectorAll('.product-card') as NodeListOf<HTMLElement>;
const countEl = document.getElementById('productsCount');
const paginacionEl = document.getElementById('paginacion');

const ITEMS_POR_PAGINA = 12;
let paginaActual = 1;
let filtroActivo = 'all';

function getVisibles() {
  return [...cards].filter(c => {
    if (filtroActivo === 'all') return true;
    return c.getAttribute('data-cat') === filtroActivo;
  });
}

function render() {
    const visibles = getVisibles();
    const totalPaginas = filtroActivo === 'all' ? Math.ceil(visibles.length / ITEMS_POR_PAGINA) : 1;

    cards.forEach(c => c.style.display = 'none');

    if (filtroActivo === 'all') {
      const inicio = (paginaActual - 1) * ITEMS_POR_PAGINA;
      const fin = inicio + ITEMS_POR_PAGINA;
      visibles.slice(inicio, fin).forEach(c => c.style.display = '');
    } else {
    visibles.forEach(c => c.style.display = '');
    }

    if (countEl) countEl.textContent = `Mostrando ${visibles.length} productos`;

    if (paginacionEl) {
      if (filtroActivo === 'all' && totalPaginas > 1) {
        let html = '';
        for (let i = 1; i <= totalPaginas; i++) {
          html += `<button class="pag-btn" data-page="${i}" style="width:38px;height:38px;border-radius:10px;cursor:pointer;font-weight:700;font-size:.9rem;border:1px solid rgba(255,255,255,.1);background:${i === paginaActual ? 'linear-gradient(135deg,var(--primary),var(--primary2))' : 'var(--bg3)'};color:var(--text);transition:var(--transition)">${i}</button>`;
        }
        paginacionEl.innerHTML = html;
        paginacionEl.style.display = 'flex';
        document.querySelectorAll('.pag-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            paginaActual = parseInt(btn.getAttribute('data-page')!);
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
        });
      } else {
        paginacionEl.style.display = 'none';
      }
    }
  }

  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      filtroActivo = btn.getAttribute('data-cat')!;
      paginaActual = 1;
      render();
    });
  });

  document.getElementById('searchInput')?.addEventListener('input', (e) => {
    const val = (e.target as HTMLInputElement).value.toLowerCase();
    cards.forEach(card => {
      const name = card.querySelector('.product-name')?.textContent?.toLowerCase() || '';
      const brand = card.querySelector('.product-brand')?.textContent?.toLowerCase() || '';
      card.style.display = (name.includes(val) || brand.includes(val)) ? '' : 'none';
    });
  });

  const params = new URLSearchParams(window.location.search);
  const catParam = params.get('cat');
  if (catParam) {
    const btn = document.querySelector(`[data-cat="${catParam}"]`) as HTMLElement;
    if (btn) btn.click();
  }

  // Filtro panel
  document.getElementById('btnFiltros')?.addEventListener('click', () => {
    const panel = document.getElementById('panelFiltros')!;
    panel.classList.toggle('hidden');
  });

  // Cerrar panel al hacer clic fuera
  document.addEventListener('click', (e) => {
    const panel = document.getElementById('panelFiltros')!;
    const btn = document.getElementById('btnFiltros')!;
    if (!panel.contains(e.target as Node) && !btn.contains(e.target as Node)) {
      panel.classList.add('hidden');
    }
  });

  // Marcas
  const marcasSet = new Set<string>();
  cards.forEach(c => {
    const brand = c.querySelector('.product-brand')?.textContent?.trim();
    if (brand) marcasSet.add(brand);
  });

  const marcasFiltroEl = document.getElementById('marcasFiltro')!;
  let marcaActiva = '';

  marcasSet.forEach(marca => {
    const btn = document.createElement('button');
    btn.textContent = marca;
    btn.className = 'px-3 py-1 rounded-full text-xs font-medium cursor-pointer';
    btn.style.cssText = 'background:var(--bg3);color:var(--text2);border:1px solid transparent';
    btn.addEventListener('click', () => {
      if (marcaActiva === marca) {
        marcaActiva = '';
        btn.style.background = 'var(--bg3)';
        btn.style.color = 'var(--text2)';
      } else {
        marcaActiva = marca;
        marcasFiltroEl.querySelectorAll('button').forEach(b => {
          (b as HTMLElement).style.background = 'var(--bg3)';
          (b as HTMLElement).style.color = 'var(--text2)';
        });
        btn.style.background = 'linear-gradient(135deg,var(--primary),var(--primary2))';
        btn.style.color = 'white';
      }
      filtrarPorMarca();
    });
    marcasFiltroEl.appendChild(btn);
  });

  function filtrarPorMarca() {
    cards.forEach(c => {
      const brand = c.querySelector('.product-brand')?.textContent?.trim();
      if (marcaActiva && brand !== marcaActiva) {
        c.style.display = 'none';
      } else {
        c.style.display = '';
      }
    });
    render();
  }

  // Ordenar por precio
  document.querySelectorAll('.orden-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const orden = btn.getAttribute('data-orden');
      document.querySelectorAll('.orden-btn').forEach(b => {
        (b as HTMLElement).style.background = 'var(--bg3)';
        (b as HTMLElement).style.color = 'var(--text2)';
      });
      (btn as HTMLElement).style.background = 'linear-gradient(135deg,var(--primary),var(--primary2))';
      (btn as HTMLElement).style.color = 'white';

      const grid = document.getElementById('catalogProducts')!;
      const cardsArr = [...cards];

      if (orden === 'asc') {
        cardsArr.sort((a, b) => {
          const pa = parseFloat(a.querySelector('.price-current')?.textContent?.replace('€','').replace('.','').replace(',','.') || '0');
          const pb = parseFloat(b.querySelector('.price-current')?.textContent?.replace('€','').replace('.','').replace(',','.') || '0');
          return pa - pb;
        });
      } else if (orden === 'desc') {
        cardsArr.sort((a, b) => {
          const pa = parseFloat(a.querySelector('.price-current')?.textContent?.replace('€','').replace('.','').replace(',','.') || '0');
          const pb = parseFloat(b.querySelector('.price-current')?.textContent?.replace('€','').replace('.','').replace(',','.') || '0');
          return pb - pa;
        });
      }

      cardsArr.forEach(c => grid.appendChild(c));
      render();
    });
  });

  render();
</script>