---
import MainLayout from '../layouts/MainLayout.astro';
import { getProducts, getCategories } from '../lib/api.js';

const products = await getProducts();
const categories = await getCategories();
---

<MainLayout title="Catálogo">
  <section class="section" style="padding-top:100px">
    <div class="section-header">
      <h2>Nuestro <span class="gradient">Catálogo</span></h2>
      <p>Explora todos nuestros productos de tecnología premium</p>
    </div>

    <div class="catalog-controls">
      <div class="filter-btns">
        <button class="filter-btn active" data-cat="all">Todos</button>
        {categories.map((cat: any) => (
          <button class="filter-btn" data-cat={cat.slug}>
            <i class={`fa-solid ${cat.slug === 'moviles' ? 'fa-mobile-screen' : cat.slug === 'portatiles' ? 'fa-laptop' : 'fa-desktop'}`}></i>
            {cat.name}
          </button>
        ))}
      </div>
      <div class="search-box">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="searchInput" placeholder="Buscar producto..." />
      </div>
    </div>

    <div class="products-grid" id="catalogProducts">
      {products.map((p: any) => (
        <a href={`/productos/${p.slug}`} class="product-card" data-cat={p.category?.slug}>
          <div class="product-img" style="background:var(--bg3)">
            {p.badge && (
              <span class={`product-badge ${p.badge}`}>
                {p.badge === 'new' ? 'Nuevo' : p.badge === 'sale' ? 'Oferta' : 'Popular'}
              </span>
            )}
            {p.image?.url
              ? <img src={`http://46.62.132.241:1337${p.image.url}`} alt={p.name} style="width:100%;height:100%;object-fit:contain;padding:1rem" />
              : <i class={`fa-solid ${p.category?.slug === 'moviles' ? 'fa-mobile-screen-button' : p.category?.slug === 'portatiles' ? 'fa-laptop' : 'fa-desktop'}`}></i>
            }
            <span class="quick-view"><i class="fa-solid fa-eye"></i> Ver detalles</span>
          </div>
          <div class="product-info">
            <div class="product-brand">{p.brand}</div>
            <h3 class="product-name">{p.name}</h3>
            <div class="product-price">
              <span class="price-current">{p.price.toLocaleString('es-ES')}€</span>
              {p.previousPrice && <span class="price-old">{p.previousPrice.toLocaleString('es-ES')}€</span>}
            </div>
            <button class="btn-comprar"
              data-id={p.documentId}
              data-name={p.name}
              data-brand={p.brand}
              data-price={p.price}
              data-cat={p.category?.slug}
              style="margin-top:.8rem;width:100%;padding:.6rem;border-radius:10px;font-weight:700;font-size:.85rem;cursor:pointer;background:rgba(108,92,231,.3);border:1px solid rgba(108,92,231,.5);color:white;border:none;transition:var(--transition)">
              COMPRAR
            </button>
          </div>
        </a>
      ))}
    </div>
    <div class="products-count" id="productsCount"></div>
  </section>

  <script is:inline>
  document.querySelectorAll('.btn-comprar').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      var carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
      var id = btn.getAttribute('data-id');
      var existing = carrito.find(function(i) { return i.id === id; });
      if (existing) {
        existing.cantidad += 1;
      } else {
        carrito.push({
          id: id,
          name: btn.getAttribute('data-name'),
          brand: btn.getAttribute('data-brand'),
          price: parseFloat(btn.getAttribute('data-price')),
          catSlug: btn.getAttribute('data-cat'),
          cantidad: 1
        });
      }
      localStorage.setItem('carrito', JSON.stringify(carrito));
      var total = carrito.reduce(function(t, i) { return t + i.cantidad; }, 0);
      var badge = document.querySelector('.nav-cart .badge');
      if (badge) badge.textContent = total.toString();
      btn.innerHTML = '<i class="fa-solid fa-check"></i> ¡Añadido!';
      btn.style.background = 'linear-gradient(135deg,#6ee7b7,#34d399)';
      setTimeout(function() {
        btn.innerHTML = 'COMPRAR';
        btn.style.background = 'rgba(108,92,231,.3)';
      }, 1500);
    });
  });
</script>
</MainLayout>

<script>
  const cards = document.querySelectorAll('.product-card') as NodeListOf<HTMLElement>;
  const countEl = document.getElementById('productsCount');

  function updateCount() {
    const visible = [...cards].filter(c => c.style.display !== 'none').length;
    if (countEl) countEl.textContent = `Mostrando ${visible} de ${cards.length} productos`;
  }

  // Filtro por categoría
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const cat = btn.getAttribute('data-cat');
      cards.forEach(card => {
        card.style.display = (cat === 'all' || card.getAttribute('data-cat') === cat) ? '' : 'none';
      });
      updateCount();
    });
  });

  // Búsqueda
  document.getElementById('searchInput')?.addEventListener('input', (e) => {
    const val = (e.target as HTMLInputElement).value.toLowerCase();
    cards.forEach(card => {
      const name = card.querySelector('.product-name')?.textContent?.toLowerCase() || '';
      const brand = card.querySelector('.product-brand')?.textContent?.toLowerCase() || '';
      card.style.display = (name.includes(val) || brand.includes(val)) ? '' : 'none';
    });
    updateCount();
  });

  // Activar filtro desde URL
  const params = new URLSearchParams(window.location.search);
  const catParam = params.get('cat');
  if (catParam) {
    const btn = document.querySelector(`[data-cat="${catParam}"]`) as HTMLElement;
    if (btn) btn.click();
  }

  updateCount();
</script>