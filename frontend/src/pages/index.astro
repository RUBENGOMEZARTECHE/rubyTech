---
import MainLayout from '../layouts/MainLayout.astro';
import { getProducts, getCategories, getFaqs } from '../lib/api.js';

const categories = await getCategories(); //Obtiene todas las categorias y las guarda en categories
const products = await getProducts(); // Obtiene todos los productos y los guarda en products
const featured = products.filter((p: any) => p.badge === 'hot' || p.rating >= 4.8).slice(0, 6); //Filtra los productos que tengan badge hot O que tengan una valoración mayor o igual a 4.8, slice(0, 6) coge solo los 6 primeros resultados. El resultado se guarda en featured
const faqs = await getFaqs(); // Obtenemos las preguntas frecuentes de Strapi
---

<MainLayout title="Inicio">

  <!-- HERO -->
  <section class="hero">
    <div class="float-shape s1"></div>
    <div class="float-shape s2"></div>
    <div class="float-shape s3"></div>
    <div class="hero-content">
      <div class="hero-badge"><i class="fa-solid fa-sparkles"></i> Nuevos lanzamientos 2024</div>
      <h1>La tecnología del <span class="gradient">futuro</span>, hoy en tus manos</h1>
      <p>Descubre nuestra selección premium de móviles, portátiles y ordenadores de sobremesa con las mejores ofertas del mercado.</p>
      <div class="hero-btns">
        <a href="/catalogo" class="btn btn-primary"><i class="fa-solid fa-bag-shopping"></i> Ver Catálogo</a>
        <a href="/contacto" class="btn btn-outline"><i class="fa-solid fa-headset"></i> Contactar</a>
      </div>
      <div class="hero-stats">
        <div class="stat"><div class="stat-num">10K+</div><div class="stat-label">Clientes felices</div></div>
        <div class="stat"><div class="stat-num">500+</div><div class="stat-label">Productos</div></div>
        <div class="stat"><div class="stat-num">99%</div><div class="stat-label">Satisfacción</div></div>
        <div class="stat"><div class="stat-num">24/7</div><div class="stat-label">Soporte técnico</div></div>
      </div>
    </div>
  </section>

  <!-- FEATURES + CATEGORÍAS + DESTACADOS -->
  <section class="section">

    <!-- FEATURES -->
    <div class="section-header fade-up">
      <h2>¿Por qué elegir <span class="gradient">RubyTech</span>?</h2>
      <p>Ofrecemos la mejor experiencia de compra en tecnología</p>
    </div>
    <div class="features fade-up">
      <div class="feature-card">
        <div class="feature-icon f1"><i class="fa-solid fa-truck-fast"></i></div>
        <h3>Envío Gratuito</h3>
        <p>En pedidos superiores a 49€. Entrega en 24-48h en toda la península.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon f2"><i class="fa-solid fa-shield-check"></i></div>
        <h3>Garantía 3 Años</h3>
        <p>Todos nuestros productos incluyen garantía extendida de 3 años.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon f3"><i class="fa-solid fa-rotate-left"></i></div>
        <h3>Devolución Fácil</h3>
        <p>30 días para devolver tu producto sin preguntas ni complicaciones.</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon f4"><i class="fa-solid fa-headset"></i></div>
        <h3>Soporte 24/7</h3>
        <p>Nuestro equipo de expertos está disponible las 24 horas del día.</p>
      </div>
    </div>

    <!-- CATEGORÍAS -->
    <div class="section-header fade-up">
      <h2>Explora nuestras <span class="gradient">categorías</span></h2>
      <p>Encuentra exactamente lo que necesitas en nuestra amplia selección</p>
    </div>
    <div class="category-grid fade-up">
      {categories.map((cat: any) => (
        <a href={`/catalogo?cat=${cat.slug}`} class="category-card">
          <div class={`cat-bg ${cat.slug}`} style={`background-image:url('/images/${cat.slug === 'ordenadores-de-sobremesa' ? 'sobremesa' : cat.slug}.jpg');background-size:cover;background-position:center`}>
          </div>
          <div class="cat-overlay">
            <div class="cat-arrow"><i class="fa-solid fa-arrow-right"></i></div>
            <h3>{cat.name}</h3>
            <p>{cat.description}</p>
          </div>
        </a>
      ))}
    </div>

    <!-- PRODUCTOS DESTACADOS -->
    <div class="section-header fade-up">
      <h2>Productos <span class="gradient">destacados</span></h2>
      <p>Lo más vendido y mejor valorado por nuestros clientes</p>
    </div>
    <div class="products-grid fade-up">
      {products.slice(0, 6).map((p: any) => (
        <a href={`/productos/${p.slug}`} class="product-card">
          <div class="product-img" style={`background:var(--bg3)`}>
            {p.badge && (
              <span class={`product-badge ${p.badge}`}>
                {p.badge === 'new' ? 'Nuevo' : p.badge === 'sale' ? 'Oferta' : 'Popular'}
              </span>
            )}
            {p.image?.url
              ? <img src={`http://46.62.132.241:1337${p.image.url}`} alt={p.name} style="width:100%;height:100%;object-fit:contain;padding:1rem" />
              : <i class={`fa-solid ${p.category?.slug === 'moviles' ? 'fa-mobile-screen-button' : p.category?.slug === 'portatiles' ? 'fa-laptop' : 'fa-desktop'}`}></i>
            }
            <span class="quick-view"><i class="fa-solid fa-eye"></i> Ver detalles</span>
          </div>
          <div class="product-info">
            <div class="product-brand">{p.brand}</div>
            <h3 class="product-name">{p.name}</h3>
            <div class="product-price">
              <span class="price-current">{p.price.toLocaleString('es-ES')}€</span>
              {p.previousPrice && <span class="price-old">{p.previousPrice.toLocaleString('es-ES')}€</span>}
            </div>
          </div>
        </a>
      ))}
    </div>

  </section>

  <!-- FAQS -->
  
  <section style="max-width:56rem;margin:0 auto;padding:4rem 1.5rem 5rem"> <!-- Sección con ancho máximo centrada -->
  <div class="text-center" style="margin-bottom:3rem"> <!-- Cabecera centrada con margen inferior -->
    <h2 class="text-4xl font-black" style="margin-bottom:1rem">Preguntas <span class="gradient">frecuentes</span></h2> <!-- Título principal -->
    <p style="color:var(--text2)">Todo lo que necesitas saber antes de comprar</p> <!-- Subtítulo -->
  </div>

  <div id="faqList"> <!-- Contenedor de todas las preguntas -->
    {faqs.map((faq: any) => ( // Recorremos el array de FAQs que viene de Strapi
      <div class="faq-item rounded-2xl overflow-hidden" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05);margin-bottom:1rem"> {/*Tarjeta de cada pregunta */}
        <button class="faq-btn w-full flex justify-between items-center text-left cursor-pointer" style="background:none;border:none;color:var(--text);padding:1.2rem 1.5rem"> {/*Botón clickable con la pregunta */}
          <span class="font-semibold">{faq.question}</span> {/*Texto de la pregunta */}
          <i class="fa-solid fa-chevron-down faq-icon" style="transition:.3s;color:var(--accent)"></i> {/*Flecha que rota al abrir */}
        </button>
        <div class="faq-answer" style="display:none;padding:0 1.5rem 1.5rem;color:var(--text2);line-height:1.7">  {/*Respuesta oculta por defecto */}
          {faq.answer} {/*texto de la respuesta */}
        </div>
      </div>
    ))}
  </div>
</section>

</MainLayout>

<script is:inline>
  var btns = document.querySelectorAll('.faq-btn'); // Seleccionamos todos los botones de las preguntas

  for (var i = 0; i < btns.length; i++) { // Recorremos cada botón
    btns[i].addEventListener('click', function() { // Añadimos un evento click a cada botón
      var answer = this.nextElementSibling; // El div de la respuesta que está justo después del botón
      var icon = this.querySelector('.faq-icon'); // El icono de la flecha dentro del botón

      if (answer.style.display === 'none') { // Si la respuesta está oculta la mostramos
        answer.style.display = 'block'; // Mostramos la respuesta
        icon.style.transform = 'rotate(180deg)'; // Giramos la flecha hacia arriba
      } else { // Si la respuesta está visible la ocultamos
        answer.style.display = 'none'; // Ocultamos la respuesta
        icon.style.transform = 'rotate(0deg)'; // Volvemos la flecha a su posición original
      }
    });
  }
</script>

<script is:inline>

  // Función que comprueba si los elementos son visibles en pantalla
  function comprobarVisibilidad() {
    
    // Obtenemos todos los elementos con la clase fade-up
    var elementos = document.querySelectorAll('.fade-up');
    
    // Recorremos cada elemento
    for (var i = 0; i < elementos.length; i++) {
      
      // Obtenemos la posición del elemento en pantalla
      var posicion = elementos[i].getBoundingClientRect();
      
      // Si el elemento está visible en pantalla le añadimos la clase visible
      if (posicion.top < window.innerHeight) {
        elementos[i].classList.add('visible');
      }
    }
  }

  // Comprobamos al cargar la página
  document.addEventListener('DOMContentLoaded', function() {
    comprobarVisibilidad();
  });

  // Comprobamos cada vez que el usuario hace scroll
  window.addEventListener('scroll', function() {
    comprobarVisibilidad();
  });

</script>
