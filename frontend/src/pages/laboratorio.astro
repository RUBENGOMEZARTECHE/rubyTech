---
import MainLayout from '../layouts/MainLayout.astro';
import { getProducts } from '../lib/api.js';

const products = await getProducts();

// Calcular estadísticas
const totalProductos = products.length;
const precioMedio = Math.round(products.reduce((t: any, p: any) => t + p.price, 0) / totalProductos);
const precioMax = Math.max(...products.map((p: any) => p.price));
const precioMin = Math.min(...products.map((p: any) => p.price));

// Por categoría
const categorias = ['moviles', 'portatiles', 'ordenadores-de-sobremesa'];
const nombresCat: Record<string, string> = {
  'moviles': 'Móviles',
  'portatiles': 'Portátiles',
  'ordenadores-de-sobremesa': 'Sobremesa'
};

const statsPorCategoria = categorias.map((slug) => {
  const prods = products.filter((p: any) => p.category?.slug === slug);
  const media = prods.length > 0 ? Math.round(prods.reduce((t: any, p: any) => t + p.price, 0) / prods.length) : 0;
  const max = prods.length > 0 ? Math.max(...prods.map((p: any) => p.price)) : 0;
  const min = prods.length > 0 ? Math.min(...prods.map((p: any) => p.price)) : 0;
  return { slug, nombre: nombresCat[slug], total: prods.length, media, max, min, productos: prods };
});

// Marcas
const marcasMap: Record<string, number> = {};
products.forEach((p: any) => {
  marcasMap[p.brand] = (marcasMap[p.brand] || 0) + 1;
});
const marcas = Object.entries(marcasMap).sort((a, b) => b[1] - a[1]).slice(0, 8);

// Badges
const badges = {
  new: products.filter((p: any) => p.badge === 'new').length,
  sale: products.filter((p: any) => p.badge === 'sale').length,
  hot: products.filter((p: any) => p.badge === 'hot').length,
  none: products.filter((p: any) => !p.badge).length,
};

// Insights automáticos
const catMasCara = statsPorCategoria.reduce((a, b) => a.media > b.media ? a : b);
const catMasBarata = statsPorCategoria.reduce((a, b) => a.media < b.media ? a : b);
const marcaTop = marcas[0];
const totalOfertas = badges.sale + badges.hot;

const insights = [
  `${catMasCara.nombre} es la categoría con el precio medio más alto: ${catMasCara.media.toLocaleString('es-ES')}€`,
  `${catMasBarata.nombre} ofrece la mejor accesibilidad con una media de ${catMasBarata.media.toLocaleString('es-ES')}€`,
  `${marcaTop[0]} es la marca más representada con ${marcaTop[1]} productos en catálogo`,
  `El ${Math.round((totalOfertas / totalProductos) * 100)}% del catálogo tiene descuento o es tendencia`,
  `Rango de precios: desde ${precioMin.toLocaleString('es-ES')}€ hasta ${precioMax.toLocaleString('es-ES')}€`,
];

const statsCategoriasJSON = JSON.stringify(statsPorCategoria.map(c => ({ nombre: c.nombre, media: c.media, max: c.max, min: c.min })));
const marcasJSON = JSON.stringify(marcas);
const badgesJSON = JSON.stringify(badges);
---

<MainLayout title="Laboratorio Tecnológico">
  <section style="max-width:1400px;margin:0 auto;padding:7rem 3rem 5rem">

    <!-- HEADER -->
    <div class="text-center" style="margin-bottom:4rem;padding-top:4rem">
      <div class="inline-flex items-center gap-2 rounded-full text-sm font-semibold mb-12" style="background:rgba(108,92,231,.15);border:1px solid rgba(108,92,231,.3);color:var(--accent);padding:0.75rem 2rem">
        <i class="fa-solid fa-flask"></i> Análisis en tiempo real
      </div>
      <div class = "pb-4">
        <h1 class="text-5xl font-black mb-4">RubyTech <span class="gradient">Intelligence</span></h1>
      </div>
      <p class="text-lg" style="color:var(--text2)">Panel de análisis avanzado generado automáticamente con los datos del catálogo</p>
    </div>

    <!-- KPIs -->
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem;margin-bottom:3rem">
      <div class="rounded-2xl p-6 text-center" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05)">
        <div class="text-4xl font-black mb-1" style="background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent">{totalProductos}</div>
        <div class="text-sm" style="color:var(--text3)">Productos totales</div>
      </div>
      <div class="rounded-2xl p-6 text-center" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05)">
        <div class="text-4xl font-black mb-1" style="background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent">{precioMedio.toLocaleString('es-ES')}€</div>
        <div class="text-sm" style="color:var(--text3)">Precio medio</div>
      </div>
      <div class="rounded-2xl p-6 text-center" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05)">
        <div class="text-4xl font-black mb-1" style="background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent">{marcas.length}</div>
        <div class="text-sm" style="color:var(--text3)">Marcas distintas</div>
      </div>
      <div class="rounded-2xl p-6 text-center" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05)">
        <div class="text-4xl font-black mb-1" style="background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent">{totalOfertas}</div>
        <div class="text-sm" style="color:var(--text3)">En oferta o tendencia</div>
      </div>
    </div>

    <!-- GRÁFICOS -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:3rem">

      <!-- Precios por categoría -->
      <div class="rounded-2xl p-6" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05)">
        <h3 class="font-bold text-lg mb-1">Precios por categoría</h3>
        <p class="text-sm mb-6" style="color:var(--text3)">Media, máximo y mínimo en €</p>
        <canvas id="chartCategorias" height="250"></canvas>
      </div>

      <!-- Marcas -->
      <div class="rounded-2xl p-6" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05)">
        <h3 class="font-bold text-lg mb-1">Ranking de marcas</h3>
        <p class="text-sm mb-6" style="color:var(--text3)">Productos por marca</p>
        <canvas id="chartMarcas" height="250"></canvas>
      </div>

      <!-- Badges -->
      <div class="rounded-2xl p-6" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05)">
        <h3 class="font-bold text-lg mb-1">Distribución de badges</h3>
        <p class="text-sm mb-6" style="color:var(--text3)">Clasificación del catálogo</p>
        <div class="flex items-center justify-center">
          <canvas id="chartBadges" height="250" width="250"></canvas>
        </div>
      </div>

      <!-- Rango de precios -->
      <div class="rounded-2xl p-6" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05)">
        <h3 class="font-bold text-lg mb-1">Rango de precios</h3>
        <p class="text-sm mb-6" style="color:var(--text3)">Distribución min/max por categoría</p>
        <canvas id="chartRango" height="250"></canvas>
      </div>

    </div>

    <!-- INSIGHTS -->
    <div class="rounded-2xl p-8" style="background:var(--bg2);border:1px solid rgba(108,92,231,.2)">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background:linear-gradient(135deg,var(--primary),var(--accent))">
          <i class="fa-solid fa-brain text-white"></i>
        </div>
        <div>
          <h3 class="font-bold text-lg">Insights automáticos</h3>
          <p class="text-sm" style="color:var(--text3)">Generados a partir de los datos reales del catálogo</p>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        {insights.map((insight, i) => (
          <div class="flex items-start gap-3 p-4 rounded-xl" style="background:var(--bg3)">
            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-black flex-shrink-0 mt-0.5" style="background:linear-gradient(135deg,var(--primary),var(--accent));color:white">{i + 1}</div>
            <p class="text-sm" style="color:var(--text2)">{insight}</p>
          </div>
        ))}
      </div>
    </div>

  </section>
</MainLayout>

<script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script define:vars={{ statsCategoriasJSON, marcasJSON, badgesJSON }}>
  const statsCategorias = JSON.parse(statsCategoriasJSON);
  const marcas = JSON.parse(marcasJSON);
  const badges = JSON.parse(badgesJSON);

  const gridColor = 'rgba(255,255,255,.05)';
  const tickColor = 'rgba(255,255,255,.4)';

  Chart.defaults.color = tickColor;
  Chart.defaults.borderColor = gridColor;

  // Gráfico categorías
  new Chart(document.getElementById('chartCategorias'), {
    type: 'bar',
    data: {
      labels: statsCategorias.map(c => c.nombre),
      datasets: [
        { label: 'Media', data: statsCategorias.map(c => c.media), backgroundColor: 'rgba(108,92,231,.8)', borderRadius: 8 },
        { label: 'Máximo', data: statsCategorias.map(c => c.max), backgroundColor: 'rgba(0,210,255,.6)', borderRadius: 8 },
        { label: 'Mínimo', data: statsCategorias.map(c => c.min), backgroundColor: 'rgba(0,184,148,.6)', borderRadius: 8 },
      ]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { grid: { color: gridColor } }, x: { grid: { color: gridColor } } } }
  });

  // Gráfico marcas
  new Chart(document.getElementById('chartMarcas'), {
    type: 'bar',
    data: {
      labels: marcas.map(m => m[0]),
      datasets: [{ label: 'Productos', data: marcas.map(m => m[1]), backgroundColor: 'rgba(108,92,231,.8)', borderRadius: 8 }]
    },
    options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { color: gridColor } }, y: { grid: { color: gridColor } } } }
  });

  // Gráfico badges
  new Chart(document.getElementById('chartBadges'), {
    type: 'doughnut',
    data: {
      labels: ['Nuevo', 'Oferta', 'Popular', 'Sin badge'],
      datasets: [{ data: [badges.new, badges.sale, badges.hot, badges.none], backgroundColor: ['rgba(0,184,148,.8)', 'rgba(255,107,107,.8)', 'rgba(253,203,110,.8)', 'rgba(255,255,255,.1)'], borderWidth: 0 }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });

  // Gráfico rango
  new Chart(document.getElementById('chartRango'), {
    type: 'bar',
    data: {
      labels: statsCategorias.map(c => c.nombre),
      datasets: [
        { label: 'Mínimo', data: statsCategorias.map(c => c.min), backgroundColor: 'rgba(0,184,148,.7)', borderRadius: 8 },
        { label: 'Máximo', data: statsCategorias.map(c => c.max), backgroundColor: 'rgba(255,107,107,.7)', borderRadius: 8 },
      ]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { grid: { color: gridColor } }, x: { grid: { color: gridColor } } } }
  });
</script>