---
import MainLayout from '../layouts/MainLayout.astro';
import { getProducts } from '../lib/api.js';

const products = await getProducts(); //Obtiene los productos de strapi y los guarda en la variable products

// Calcular estadísticas
const totalProductos = products.length;
const precioMedio = Math.round(products.reduce((acum: any, p: any) => acum + p.price, 0) / totalProductos); //Math.round redondea a un numero entero - Aqui queremos recorrer todos los productos y sumar todos los precios
const precioMax = Math.max(...products.map((p: any) => p.price)); //Aqui buscamos el precio mas alto de todos los productos - el spread convierte el arrya en valores sueltos - Math.max devuelve el numero mas alto de todos los valores
const precioMin = Math.min(...products.map((p: any) => p.price)); //Al contrario

// Por categoría
const categorias = ['moviles', 'portatiles', 'ordenadores-de-sobremesa'];
const nombresCat: Record<string, string> = { //En este caso añadiremos esta sentencia de TypeScript si no se nos romepra el codigo mas abajo. tiene claves de tipo texto y valores de tipo texto
  'moviles': 'Móviles',
  'portatiles': 'Portátiles',
  'ordenadores-de-sobremesa': 'Sobremesa'
};

const statsPorCategoria = categorias.map((slug) => { //Recorr eel array categorias y el resultado del codigo lo guarda aqui
  const prods = products.filter((p: any) => p.category?.slug === slug); //Filtra todos los productos y se queda solo con los que pertenecen a la categoria actual. p: any = cada producto sin importarme el tipo de dato. Si no hay productos devolverá 0
  const media = prods.length > 0 ? Math.round(prods.reduce((acum: any, p: any) => acum + p.price, 0) / prods.length) : 0; //calculamos el precio medio de los productos de esta categoria
  const max = prods.length > 0 ? Math.max(...prods.map((p: any) => p.price)) : 0; //Buscamos el precio mas alto de esta categoria, recorremos todos los productos con .map
  const min = prods.length > 0 ? Math.min(...prods.map((p: any) => p.price)) : 0;
  return { slug, nombre: nombresCat[slug], total: prods.length, media, max, min, productos: prods }; //devolvera un objeto con toda la info de esta categoria
});

// Marcas
const marcasMap: Record<string, number> = {};
products.forEach((p: any) => {
  marcasMap[p.brand] = (marcasMap[p.brand] || 0) + 1;
});
const marcas = Object.entries(marcasMap).sort((a, b) => b[1] - a[1]).slice(0, 8);

// Badges
const badges = {
  new: products.filter((p: any) => p.badge === 'new').length,
  sale: products.filter((p: any) => p.badge === 'sale').length,
  hot: products.filter((p: any) => p.badge === 'hot').length,
  none: products.filter((p: any) => !p.badge).length,
};

// Datos automáticos
const catMasCara = statsPorCategoria.reduce((a, b) => a.media > b.media ? a : b); // Buscamos la categoría con el precio medio más alto comparando de dos en dos
const catMasBarata = statsPorCategoria.reduce((a, b) => a.media < b.media ? a : b); // Buscamos la categoría con el precio medio más bajo comparando de dos en dos
const marcaTop = marcas[0]; // La primera posición del array es la marca con más productos ya que está ordenado de mayor a menor
const totalOfertas = badges.sale + badges.hot; // Sumamos los productos en oferta y los productos populares para obtener el total de productos con descuento o tendencia

const insights = [ // Array de frases generadas automáticamente con los datos reales del catálogo
  `${catMasCara.nombre} es la categoría con el precio medio más alto: ${catMasCara.media.toLocaleString('es-ES')}€`,  // categoría con el precio medio más alto
  `${catMasBarata.nombre} ofrece la mejor accesibilidad con una media de ${catMasBarata.media.toLocaleString('es-ES')}€`, // categoría con el precio medio más bajo
  `${marcaTop[0]} es la marca más representada con ${marcaTop[1]} productos en catálogo`, //marca con más productos en el catálogo
  `El ${Math.round((totalOfertas / totalProductos) * 100)}% del catálogo tiene descuento o es tendencia`,   //porcentaje de productos en oferta o tendencia
  `Rango de precios: desde ${precioMin.toLocaleString('es-ES')}€ hasta ${precioMax.toLocaleString('es-ES')}€`, //rango de precios del catálogo completo
];

const statsCategoriasJSON = JSON.stringify(statsPorCategoria.map(c => ({ nombre: c.nombre, media: c.media, max: c.max, min: c.min }))); // Solo cogemos los datos que necesitamos: nombre, media, máximo y mínimo
const marcasJSON = JSON.stringify(marcas);
const badgesJSON = JSON.stringify(badges); // Convertimos los badges a texto JSON para poder pasárselos al script del navegador
---

<MainLayout title="Laboratorio Tecnológico">
  <section style="max-width:1400px;margin:0 auto;padding:7rem 3rem 5rem">

    <!-- HEADER -->
    <div class="text-center" style="margin-bottom:4rem;padding-top:4rem">
      <div class="inline-flex items-center gap-2 rounded-full text-sm font-semibold mb-12" style="background:rgba(108,92,231,.15);border:1px solid rgba(108,92,231,.3);color:var(--accent);padding:0.75rem 2rem">
        <i class="fa-solid fa-flask"></i> Análisis en tiempo real
      </div>
      <div class = "pb-4">
        <h1 class="text-5xl font-black" style="margin:1.5rem 0">RubyTech <span class="gradient">Intelligence</span></h1>
      </div>
      <p class="text-lg" style="color:var(--text2);margin-top:1rem">Panel de análisis avanzado generado automáticamente con los datos del catálogo</p>
    </div>

    <!-- KPIs -->
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem;margin-bottom:3rem">
      <div class="rounded-2xl text-center" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05);padding:2.5rem 1rem">
        <div class="text-4xl font-black mb-1" style="background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent">{totalProductos}</div>
        <div class="text-sm" style="color:var(--text3)">Productos totales</div>
      </div>
      <div class="rounded-2xl text-center" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05);padding:2.5rem 1rem">
        <div class="text-4xl font-black mb-1" style="background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent">{precioMedio.toLocaleString('es-ES')}€</div>
        <div class="text-sm" style="color:var(--text3)">Precio medio</div>
      </div>
      <div class="rounded-2xl text-center" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05);padding:2.5rem 1rem">
        <div class="text-4xl font-black mb-1" style="background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent">{marcas.length}</div>
        <div class="text-sm" style="color:var(--text3)">Marcas distintas</div>
      </div>
      <div class="rounded-2xl text-center" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05);padding:2.5rem 1rem">
        <div class="text-4xl font-black mb-1" style="background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent">{totalOfertas}</div>
        <div class="text-sm" style="color:var(--text3)">En oferta o tendencia</div>
      </div>
    </div>

    <!-- GRÁFICOS -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:3rem">

      <!-- Precios por categoría -->
      <div class="rounded-2xl p-8" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05);padding:2rem">
        <h3 class="font-bold text-lg mb-1">Precios por categoría</h3>
        <p class="text-sm mb-6" style="color:var(--text3)">Media, máximo y mínimo en €</p>
        <canvas id="chartCategorias" height="250"></canvas>
      </div>

      <!-- Marcas -->
      <div class="rounded-2xl p-6" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05);padding:2rem">
        <h3 class="font-bold text-lg mb-1">Ranking de marcas</h3>
        <p class="text-sm mb-6" style="color:var(--text3)">Productos por marca</p>
        <canvas id="chartMarcas" height="250"></canvas>
      </div>

      <!-- Badges -->
      <div class="rounded-2xl p-6" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05);padding:2rem">
        <h3 class="font-bold text-lg mb-1">Distribución de badges</h3>
        <p class="text-sm mb-6" style="color:var(--text3)">Clasificación del catálogo</p>
        <div class="flex items-center justify-center">
          <canvas id="chartBadges" height="250" width="250"></canvas>
        </div>
      </div>

      <!-- Rango de precios -->
      <div class="rounded-2xl p-6" style="background:var(--bg2);border:1px solid rgba(255,255,255,.05);padding:2rem">
        <h3 class="font-bold text-lg mb-1">Rango de precios</h3>
        <p class="text-sm mb-6" style="color:var(--text3)">Distribución min/max por categoría</p>
        <canvas id="chartRango" height="250"></canvas>
      </div>

    </div>

    <!-- INSIGHTS -->
    <div class="rounded-2xl" style="background:var(--bg2);border:1px solid rgba(108,92,231,.2);padding:2.5rem">
      <div class="flex items-center gap-3" style="margin-bottom:2rem">
        <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background:linear-gradient(135deg,var(--primary),var(--accent))">
          <i class="fa-solid fa-brain text-white"></i>
        </div>
        <div>
          <h3 class="font-bold text-lg">Insights automáticos</h3>
          <p class="text-sm" style="color:var(--text3)">Generados a partir de los datos reales del catálogo</p>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        {insights.map((insight, i) => (
          <div class="flex items-start gap-3 rounded-xl" style="background:var(--bg3);padding:1.2rem 1.5rem">
            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-black flex-shrink-0 mt-0.5" style="background:linear-gradient(135deg,var(--primary),var(--accent));color:white">{i + 1}</div>
            <p class="text-sm" style="color:var(--text2)">{insight}</p>
          </div>
        ))}
      </div>
    </div>

  </section>
</MainLayout>


{/*IMPORTAMOS LIBRERIA CHART.JS */}
<script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
<script define:vars={{ statsCategoriasJSON, marcasJSON, badgesJSON }}>
  const statsCategorias = JSON.parse(statsCategoriasJSON);
  const marcas = JSON.parse(marcasJSON);
  const badges = JSON.parse(badgesJSON);

  const gridColor = 'rgba(255,255,255,.05)';
  const tickColor = 'rgba(255,255,255,.4)';

  Chart.defaults.color = tickColor;
  Chart.defaults.borderColor = gridColor;

  // Gráfico categorías
  new Chart(document.getElementById('chartCategorias'), { // Creamos el gráfico de barras verticales para mostrar los precios por categoría
    type: 'bar', //barras verticales
    data: {
      labels: statsCategorias.map(c => c.nombre), //etiquetas eje x: nombres de categorias
      datasets: [
        { label: 'Media', data: statsCategorias.map(c => c.media), backgroundColor: 'rgba(108,92,231,.8)', borderRadius: 8 }, // Barra morada: precio medio de cada categoría
        { label: 'Máximo', data: statsCategorias.map(c => c.max), backgroundColor: 'rgba(0,210,255,.6)', borderRadius: 8 }, // Barra azul: precio máximo de cada categoría
        { label: 'Mínimo', data: statsCategorias.map(c => c.min), backgroundColor: 'rgba(0,184,148,.6)', borderRadius: 8 },   // Barra verde: precio mínimo de cada categoría
      ]
    },
    options: { 
      responsive: true, // El gráfico se adapta al tamaño de la pantalla
      plugins: { 
        legend: { position: 'bottom' } // La leyenda se muestra en la parte inferior del gráfico
      }, 
      scales: { // Color de las líneas en el eje Y y X
        y: { grid: { color: gridColor } }, 
        x: { grid: { color: gridColor } } 
      } }
  });

  // Gráfico marcas
  new Chart(document.getElementById('chartMarcas'), { // Creamos el gráfico de barras para mostrar el ranking de marcas
    type: 'bar', //barras
    data: {
      labels: marcas.map(m => m[0]), //etiquetas del eje y : nombres de las marcas
      datasets: [{ //barra morada: numero de productos de cada marca
        label: 'Productos', 
        data: marcas.map(m => m[1]), 
        backgroundColor: 'rgba(108,92,231,.8)', 
        borderRadius: 8 
      }]
    },
    options: { 
      indexAxis: 'y', //barras horizontales hacia la derecha
      responsive: true, 
      plugins: { 
        legend: { display: false } //ocultamos la leyenda
      }, 
      scales: { 
        x: { grid: { color: gridColor } }, 
        y: { grid: { color: gridColor } } 
      } }
  });

  // Gráfico badges
  new Chart(document.getElementById('chartBadges'), { //grafico de donut para mostrar la distribucion de badges
    type: 'doughnut', //tipo de donut con agujero en el centro
    data: {
      labels: ['Nuevo', 'Oferta', 'Popular', 'Sin badge'],//cada badge
      datasets: [{ 
        data: [badges.new, badges.sale, badges.hot, badges.none], // Cantidad de productos de cada tipo de badge
        backgroundColor: ['rgba(0,184,148,.8)', 'rgba(255,107,107,.8)', 'rgba(253,203,110,.8)', 'rgba(255,255,255,.1)'], // Color de cada sección: verde, rojo, amarillo y blanco transparente
        borderWidth: 0  // Sin borde entre las secciones
      }]
    },
    options: { 
      responsive: true, 
      plugins: { 
        legend: { position: 'bottom' } // La leyenda se muestra en la parte inferior del gráfico
      } 
    }
  });

  // Gráfico rango
  new Chart(document.getElementById('chartRango'), { //grafico de barras para mostrar el rango de precios
    type: 'bar',
    data: {
      labels: statsCategorias.map(c => c.nombre), //Eje x: nombre de las categorias
      datasets: [
        { label: 'Mínimo', data: statsCategorias.map(c => c.min), backgroundColor: 'rgba(0,184,148,.7)', borderRadius: 8 }, // Barra verde: precio mínimo de cada categoría
        { label: 'Máximo', data: statsCategorias.map(c => c.max), backgroundColor: 'rgba(255,107,107,.7)', borderRadius: 8 }, // Barra roja: precio máximo de cada categoría
      ]
    },
    options: { 
      responsive: true, 
      plugins: { legend: { position: 'bottom' } }, 
      scales: { y: { grid: { color: gridColor } }, 
      x: { grid: { color: gridColor } } 
    } }
  });
</script>